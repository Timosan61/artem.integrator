# История отладки Artyom Integrator

## 2025-07-24 - Двойной ответ на команду /agent

### Описание ошибки
При отправке команды `/agent` пользователь получал два ответа:
1. Корректный статус Intelligent Agent
2. Объяснение про команду /agent в Minecraft Education Edition

### Симптомы
- Пользователь написал `/agent` 
- Получил правильный ответ со статусом агента
- Сразу после этого получил объяснение про Minecraft
- В логах видно, что команда обработана дважды

### Попытки исправления
#### Попытка 1: Проверка обработки специальных команд
**Проблема**: Думал, что команда не возвращается после обработки
**Действие**: Проверил код в webhook handlers - там всё корректно
**Результат**: ❌ Проблема осталась

#### Попытка 2: Добавление фильтра в IntelligentAgentService
**Проблема**: Intelligent Agent обрабатывал уже обработанные команды
**Действие**: Добавил список игнорируемых команд
**Результат**: ❌ Создало новую проблему с пустыми сообщениями

### Финальное решение
1. Откатил изменения в IntelligentAgentService
2. Исправил ошибки в методах:
   - Добавил `list_tools()` в ToolRegistry
   - Исправил `get_user_state` на `get_pending_sessions` в ConfirmationManager
   - Исправил подсчет активных подтверждений
3. Убедился, что специальные команды корректно возвращаются из обработчика

### Важные уроки
1. **Проблема была в неработающем коде**, а не в логике flow
2. Когда метод _handle_special_command падал с ошибкой, управление передавалось агенту
3. Всегда проверять логи на наличие исключений перед изменением логики
4. Тестировать локально перед отправкой в продакшн

## 2025-07-21 - HTML Parse Mode и экранирование в Telegram

### Описание ошибки
Бот успешно обрабатывал сообщения и генерировал ответы, но сообщения не доставлялись пользователям в Telegram

### Симптомы
- В логах: "Response sent successfully"
- В Telegram: сообщения не появлялись
- Telegram API возвращал 400 Bad Request

### Попытки исправления
#### Попытка 1: Проверка прав бота
**Проблема**: Думал, что у бота нет прав писать в чат
**Действие**: Проверил права и chat_id
**Результат**: ❌ Права были в порядке

#### Попытка 2: Отправка через requests
**Проблема**: Думал, что проблема в python-telegram-bot
**Действие**: Переписал на прямые API вызовы
**Результат**: ❌ Та же ошибка

### Финальное решение
HTML теги в тексте требуют экранирования:
- `<something>` → `&lt;something&gt;`
- `&` → `&amp;`
- Или использовать parse_mode='Markdown' вместо 'HTML'

### Важные уроки
1. Telegram строго проверяет HTML разметку
2. Любые спецсимволы должны быть экранированы
3. Лучше использовать Markdown для простых сообщений
4. Всегда проверять response.text при ошибках API