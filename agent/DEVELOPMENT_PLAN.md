# План разработки Intelligent Agent

## Обзор
Поэтапная разработка интеллектуального агента с поддержкой инструментов для Artem Integrator.

## ЭТАП 1: Базовый агент с OpenAI Function Calling
**Цель:** Создать фундамент агента с базовой логикой Function Calling

### Задачи:
1. ✅ Создать структуру папок agent/
2. [ ] Реализовать `core/intelligent_agent.py` с:
   - Базовым классом IntelligentAgent
   - Интеграцией с OpenAI API
   - Простейшим Function Calling
3. [ ] Создать Pydantic модели в `core/models.py`:
   - BaseToolParams
   - ToolResponse
   - AgentResponse
4. [ ] Создать простой echo-инструмент для тестирования
5. [ ] Написать тесты в `tests/test_basic_agent.py`

### Тестирование:
```python
# Проверка, что агент:
- Может вызвать функцию
- Правильно парсит параметры
- Возвращает результаты
```

### Критерии завершения:
- [ ] Агент успешно вызывает echo-функцию
- [ ] Pydantic валидирует параметры
- [ ] Тесты проходят

---

## ЭТАП 2: Система инструментов (Tool System)
**Цель:** Создать расширяемую систему инструментов

### Задачи:
1. [ ] Создать `tools/base.py` с абстрактным классом BaseTool
2. [ ] Реализовать `core/tool_registry.py`:
   - Регистрация инструментов
   - Динамическая загрузка
   - Генерация схем для OpenAI
3. [ ] Создать первый реальный инструмент - MCPTool
4. [ ] Интегрировать с существующим ClaudeCodeService
5. [ ] Написать тесты в `tests/test_tools.py`

### Тестирование:
```python
# Проверка:
- Регистрация инструментов
- Вызов MCPTool с моковым ClaudeCodeService
- Обработка ошибок инструментов
```

### Критерии завершения:
- [ ] ToolRegistry работает
- [ ] MCPTool успешно регистрируется
- [ ] Можно добавлять новые инструменты

---

## ЭТАП 3: Intent Classification и маршрутизация
**Цель:** Научить агента понимать намерения пользователя

### Задачи:
1. [ ] Создать `core/intent_classifier.py`:
   - Анализ текста на ключевые слова
   - Определение подходящего инструмента
   - Confidence scoring
2. [ ] Загрузка паттернов из `agent_config.yaml`
3. [ ] Кэширование частых запросов
4. [ ] Fallback на general chat
5. [ ] Тесты в `tests/test_intent_classifier.py`

### Тестирование:
```python
# Проверка классификации:
- "покажи приложения" → MCPTool
- "нарисуй кота" → ImageGenerator
- "привет" → General Chat
```

### Критерии завершения:
- [ ] Точность классификации > 90%
- [ ] Правильное определение confidence
- [ ] Работает fallback

---

## ЭТАП 4: Confirmation Manager
**Цель:** Реализовать систему подтверждений действий

### Задачи:
1. [ ] Создать `core/confirmation_manager.py`:
   - Состояния разговора
   - Форматирование запросов подтверждения
   - Обработка ответов пользователя
2. [ ] Интеграция с агентом
3. [ ] Настройка порогов из конфига
4. [ ] Альтернативные варианты действий
5. [ ] Тесты в `tests/test_confirmation_flow.py`

### Тестирование:
```python
# Сценарии:
- Запрос → Подтверждение → Выполнение
- Запрос → Отказ → Альтернативы
- Неясный запрос → Уточнение
```

### Критерии завершения:
- [ ] Корректная обработка всех типов ответов
- [ ] Сохранение контекста между сообщениями
- [ ] UX-friendly сообщения

---

## ЭТАП 5: Реальные инструменты
**Цель:** Интегрировать существующие сервисы как инструменты

### Задачи:
1. [ ] Интегрировать ClaudeCodeService как MCPTool
2. [ ] Создать ImageGeneratorTool:
   - Интеграция с DALL-E API
   - Обработка стилей и размеров
3. [ ] Создать VisionAnalyzerTool:
   - Скачивание видео/изображений
   - Анализ через GPT-4 Vision
4. [ ] Создать моки для тестирования
5. [ ] Тесты в `tests/test_real_tools.py`

### Тестирование:
```python
# С моками API:
- MCP команды
- Генерация изображений
- Анализ видео
```

### Критерии завершения:
- [ ] Все инструменты работают с моками
- [ ] Правильная обработка ошибок API
- [ ] Унифицированный формат ответов

---

## ЭТАП 6: Memory и Learning
**Цель:** Добавить память и обучение на предпочтениях

### Задачи:
1. [ ] Интегрировать с существующим MemoryManager
2. [ ] Создать `core/preference_learner.py`:
   - Сохранение выборов пользователя
   - Анализ паттернов
   - Автоматические предпочтения
3. [ ] Persistence в Supabase/файлы
4. [ ] TTL для предпочтений
5. [ ] Тесты в `tests/test_memory_learning.py`

### Тестирование:
```python
# Проверка:
- Запоминание после N повторений
- Применение предпочтений
- Очистка старых данных
```

### Критерии завершения:
- [ ] Агент запоминает предпочтения
- [ ] Корректно применяет их
- [ ] Можно сбросить предпочтения

---

## ЭТАП 7: Интеграция с Telegram
**Цель:** Встроить агента в существующий бот

### Задачи:
1. [ ] Обновить `webhook/handlers.py`:
   - Новый роут для агента
   - Обработка состояний
2. [ ] Админские команды:
   - `/agent_status` - статус агента
   - `/agent_tools` - список инструментов
   - `/agent_reset` - сброс состояния
3. [ ] Миграция с простого response_generator
4. [ ] Настройка прав доступа
5. [ ] E2E тест с реальным ботом

### Тестирование:
```bash
# Локальный запуск:
- Отправка сообщений
- Проверка подтверждений
- Выполнение инструментов
```

### Критерии завершения:
- [ ] Бот отвечает через агента
- [ ] Работают подтверждения
- [ ] Инструменты выполняются

---

## ЭТАП 8: Финальное тестирование и документация
**Цель:** Подготовить к production

### Задачи:
1. [ ] Интеграционные тесты всех компонентов
2. [ ] Нагрузочное тестирование:
   - Параллельные запросы
   - Большие контексты
3. [ ] Edge cases:
   - Таймауты API
   - Некорректные данные
   - Прерывание разговора
4. [ ] Документация:
   - API reference
   - Примеры использования
   - Deployment guide
5. [ ] Мониторинг и метрики

### Критерии готовности к production:
- [ ] Покрытие тестами > 80%
- [ ] Документация полная
- [ ] Нет критических багов
- [ ] Performance benchmarks пройдены

---

## Временные оценки

| Этап | Оценка времени | Приоритет |
|------|----------------|-----------|
| 1. Базовый агент | 2-3 дня | Высокий |
| 2. Tool System | 2-3 дня | Высокий |
| 3. Intent Classification | 2 дня | Средний |
| 4. Confirmation Manager | 2 дня | Средний |
| 5. Реальные инструменты | 3-4 дня | Высокий |
| 6. Memory & Learning | 2 дня | Низкий |
| 7. Telegram интеграция | 2-3 дня | Высокий |
| 8. Финальное тестирование | 3 дня | Высокий |

**Общая оценка:** 18-23 дня

## Риски и митигация

1. **Сложность Function Calling**
   - Риск: Неправильный выбор функций
   - Митигация: Детальные промпты и примеры

2. **Производительность**
   - Риск: Медленные ответы при множестве инструментов
   - Митигация: Кэширование и оптимизация

3. **Обратная совместимость**
   - Риск: Поломка существующего функционала
   - Митигация: Постепенная миграция, feature flags

4. **Стоимость API**
   - Риск: Высокие расходы на GPT-4
   - Митигация: Умное кэширование, fallback на GPT-3.5

## Определение успеха

✅ Агент корректно классифицирует 95%+ запросов
✅ Пользователи понимают и используют подтверждения
✅ Время ответа < 5 секунд для простых запросов
✅ Успешная интеграция всех существующих сервисов
✅ Положительный фидбек от тестовых пользователей