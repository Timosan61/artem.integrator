# –≠—Ç–∞–ø 7: Telegram Integration - –ó–ê–í–ï–†–®–ï–ù ‚úÖ

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

1. **IntelligentAgentService** ‚úÖ
   - –°–æ–∑–¥–∞–Ω —Å–µ—Ä–≤–∏—Å-–º–æ—Å—Ç –º–µ–∂–¥—É Intelligent Agent –∏ Telegram –±–æ—Ç–æ–º
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ToolRegistry –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π —á–µ—Ä–µ–∑ ConfirmationManager
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –ø–∞–º—è—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

2. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Webhook Handlers** ‚úÖ
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Intelligent Agent –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ù–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ `/agent` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
   - –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ help —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∞–≥–µ–Ω—Ç–µ

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π** ‚úÖ
   - –°–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Å—Å–∏–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ "–¥–∞"/"–Ω–µ—Ç" –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞

4. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å MCP Tool** ‚úÖ
   - –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–≤–æ–π—Å—Ç–≤–æ `metadata` –≤ MCPTool –¥–ª—è ToolRegistry
   - –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º ClaudeCodeService
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —ç–º—É–ª—è—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:

1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–æ–ª—è–º**:
   ```python
   # –ê–¥–º–∏–Ω—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç Intelligent Agent
   if intelligent_agent_service and intelligent_agent_service.is_available() and message.user.role == UserRole.ADMIN:
       response = await intelligent_agent_service.process_message(message)
   else:
       # –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∞–≥–µ–Ω—Ç
       response = await self.agent.process_message(message)
   ```

2. **–ö–æ–º–∞–Ω–¥–∞ /agent**:
   ```
   üß† **Intelligent Agent Status**
   
   Enabled: ‚úÖ
   Available: ‚úÖ
   
   **Registered Tools:**
   ‚Ä¢ mcp_executor
   ‚Ä¢ youtube_analyzer
   
   **Active Confirmations:** 0
   ```

3. **–û–±–æ–≥–∞—â–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã**:
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ
   - –ü–æ–∫–∞–∑ —É—Ä–æ–≤–Ω—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –Ω–∏–∑–∫–æ–π confidence
   - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

```python
# test_telegram_integration.py
TestIntelligentAgentService:
‚úÖ test_process_message_success - —É—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
‚úÖ test_process_message_with_confirmation - –∑–∞–ø—Ä–æ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
‚úÖ test_handle_confirmation_positive - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
‚úÖ test_handle_confirmation_negative - –æ—Ç–º–µ–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
‚úÖ test_service_not_available - —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
‚úÖ test_get_status - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞

TestWebhookIntegration:
‚úÖ test_admin_uses_intelligent_agent - –∞–¥–º–∏–Ω—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç IA
‚úÖ test_regular_user_uses_standard_agent - –æ–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
‚úÖ test_agent_command - –∫–æ–º–∞–Ω–¥–∞ /agent —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ test_agent_command_not_available - /agent –∫–æ–≥–¥–∞ —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

TestHelperIntegration:
‚úÖ test_help_shows_agent_info_for_admin - help –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç info –æ–± –∞–≥–µ–Ω—Ç–µ
```

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

1. **–ê–¥–º–∏–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ**:
   ```
   User: –ø–æ–∫–∞–∂–∏ –≤—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   Bot: –í–æ—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π:
   - web-app (nyc3) - active
   - api-service (sfo2) - active
   
   _üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω: mcp_
   ```

2. **–ó–∞–ø—Ä–æ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è**:
   ```
   User: —É–¥–∞–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ test-app
   Bot: üìã **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ MCP –∫–æ–º–∞–Ω–¥—ã**
   
   –í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ test-app?
   
   –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!
   
   ‚úÖ –î–∞ / ‚ùå –ù–µ—Ç
   
   User: –¥–∞
   Bot: ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ test-app —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ
   ```

3. **–û–±—É—á–µ–Ω–∏–µ –Ω–∞ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö**:
   - –ö–∞–∂–¥—ã–π –≤—ã–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
   - –ü–æ—Å–ª–µ 3+ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ
   - –ê–≥–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:

–î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ Intelligent Agent –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:

1. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å OpenAI API –∫–ª—é—á**:
   ```bash
   export OPENAI_API_KEY="sk-..."
   ```

2. **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: YouTube API –∫–ª—é—á**:
   ```bash
   export YOUTUBE_API_KEY="AIza..."
   ```

3. **–ë—ã—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º** –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `/mcp_enable`

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:

```
Telegram Update
    ‚Üì
WebhookHandler
    ‚Üì
[Role Check]
    ‚îú‚îÄ Admin ‚Üí IntelligentAgentService
    ‚îÇ              ‚Üì
    ‚îÇ         IntelligentAgent
    ‚îÇ              ‚Üì
    ‚îÇ         [Intent Classification]
    ‚îÇ              ‚Üì
    ‚îÇ         [Tool Selection]
    ‚îÇ              ‚Üì
    ‚îÇ         [Preference Learning]
    ‚îÇ              ‚Üì
    ‚îÇ         [Tool Execution]
    ‚îÇ
    ‚îî‚îÄ User ‚Üí Standard Agent
```

## –ò—Ç–æ–≥–∏ —ç—Ç–∞–ø–∞

Intelligent Agent –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ Telegram –±–æ—Ç–∞:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏ –ø–æ —Ä–æ–ª–∏
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π Intelligent Agent
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- ‚úÖ –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

## –°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø

–≠—Ç–∞–ø 8: –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã.